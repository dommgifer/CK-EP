# T093: Docker Compose æœå‹™æ•´åˆé…ç½®
# Kubernetes è€ƒè©¦æ¨¡æ“¬å™¨å®Œæ•´ç’°å¢ƒç·¨æ’

services:
  # ====================================
  # æ ¸å¿ƒåŸºç¤è¨­æ–½æœå‹™
  # ====================================

  # nginx åå‘ä»£ç† - çµ±ä¸€å…¥å£é»
  nginx:
    image: nginx:1.25-alpine
    container_name: k8s-exam-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/empty.conf:/etc/nginx/conf.d/default.conf
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - frontend_build:/usr/share/nginx/html
      - ./nginx/logs:/var/log/nginx
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_completed_successfully
    restart: unless-stopped
    networks:
      - exam-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "com.k8s-exam.component=proxy"
      - "com.k8s-exam.version=1.0.0"

  # å¾Œç«¯ FastAPI æœå‹™
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: production
    container_name: k8s-exam-backend
    environment:
      # æ‡‰ç”¨è¨­å®š
      - PYTHONPATH=/app
      - ENVIRONMENT=production
      - LOG_LEVEL=INFO

      # è³‡æ–™åº«è¨­å®š
      - DATABASE_URL=sqlite:///./data/exam_simulator.db
      - REDIS_URL=redis://redis:6379/0

      # å„²å­˜è¨­å®š
      - DATA_DIR=/app/data
      - QUESTION_SETS_DIR=/app/data/question_sets
      - VM_CONFIGS_DIR=/app/data/vm_configs
      - SSH_KEYS_DIR=/app/data/ssh_keys

      # Docker è¨­å®š
      - DOCKER_HOST=unix:///var/run/docker.sock
      - KUBESPRAY_IMAGE=quay.io/kubespray/kubespray:v2.23.1

      # ç¶²è·¯è¨­å®š
      - DOCKER_NETWORK=k8s-exam-simulator_exam-network

      # å®‰å…¨è¨­å®š
      - SECRET_KEY=${SECRET_KEY:-your-secret-key-here}
      - CORS_ORIGINS=http://localhost,http://localhost:3000
    volumes:
      - ./data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock
      - ./backend/logs:/app/logs
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - exam-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.k8s-exam.component=backend"
      - "com.k8s-exam.version=1.0.0"

  # å‰ç«¯ React æ‡‰ç”¨å»ºç½®
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: builder
    container_name: k8s-exam-frontend-build
    volumes:
      - frontend_build:/shared
    command: sh -c "
      echo 'ğŸš€ Starting frontend build sync...' &&
      echo 'ğŸ“‚ Copying build files to shared volume...' &&
      cp -r /app/dist/* /shared/ &&
      echo 'âœ… Frontend build sync completed!' &&
      echo 'ğŸ“… Sync timestamp:' $(date) &&
      ls -la /shared/"
    restart: "no"
    networks:
      - exam-network
    labels:
      - "com.k8s-exam.component=frontend-build"
      - "com.k8s-exam.version=1.0.0"

  # Redis å¿«å–å’Œæœƒè©±å„²å­˜
  redis:
    image: redis:7.2-alpine
    container_name: k8s-exam-redis
    command: ["redis-server", "/etc/redis/redis.conf"]
    ports:
      - "127.0.0.1:6379:6379"  # åªåœ¨æœ¬æ©Ÿä»‹é¢ç›£è½
    volumes:
      - redis_data:/data
      - ./redis/redis.conf:/etc/redis/redis.conf:ro
      - ./redis/logs:/var/log/redis
    restart: unless-stopped
    networks:
      - exam-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "com.k8s-exam.component=cache"
      - "com.k8s-exam.version=1.0.0"

  # ====================================
  # è€ƒè©¦ç’°å¢ƒå®¹å™¨ï¼ˆå‹•æ…‹ç®¡ç†ï¼‰
  # ====================================

  # Kubespray éƒ¨ç½²æœå‹™ï¼ˆæŒ‰éœ€å•Ÿå‹•ï¼‰
  kubespray:
    image: quay.io/kubespray/kubespray:v2.23.1
    container_name: k8s-exam-kubespray
    volumes:
      - ./data/kubespray_configs:/kubespray/inventory
      - ./data/ssh_keys:/root/.ssh:ro
      - kubespray_cache:/tmp
    working_dir: /kubespray
    command: ["tail", "-f", "/dev/null"]  # ä¿æŒå®¹å™¨é‹è¡Œ
    restart: unless-stopped
    networks:
      - exam-network
    profiles:
      - kubespray
    labels:
      - "com.k8s-exam.component=kubespray"
      - "com.k8s-exam.version=1.0.0"

# ====================================
# å‹•æ…‹å®¹å™¨ç¯„æœ¬ï¼ˆç”±å¾Œç«¯æœå‹™ç®¡ç†ï¼‰
# ====================================
# æ³¨æ„ï¼šä»¥ä¸‹å®¹å™¨ä¸æœƒè‡ªå‹•å•Ÿå‹•ï¼Œè€Œæ˜¯ç”±å¾Œç«¯æœå‹™æ ¹æ“šè€ƒè©¦æœƒè©±å‹•æ…‹å»ºç«‹

  # VNC æ¡Œé¢å®¹å™¨ç¯„æœ¬
  vnc-template:
    build:
      context: ./containers/vnc
      dockerfile: Dockerfile
    image: k8s-exam/vnc:latest
    container_name: vnc-template
    environment:
      - VNC_PW=${VNC_PASSWORD:-examvnc}
      - VNC_RESOLUTION=${VNC_RESOLUTION:-1280x1024}
      - DISPLAY=:1
      - VNC_PORT=5901
      - NO_VNC_PORT=6901
      - BASTION_HOST=bastion-${SESSION_ID}
    volumes:
      - ./data/ssh_keys:/headless/.ssh:ro
      - vnc_workspace:/headless/workspace
    networks:
      - exam-network
    profiles:
      - template
    labels:
      - "com.k8s-exam.component=vnc-template"
      - "com.k8s-exam.type=exam-environment"

  # Bastion å·¥å…·å®¹å™¨ç¯„æœ¬
  bastion-template:
    build:
      context: ./containers/bastion
      dockerfile: Dockerfile
    image: k8s-exam/bastion:latest
    container_name: bastion-template
    environment:
      - KUBECONFIG=/kubeconfig/config
      - TERM=xterm-256color
      - SHELL=/bin/bash
      - TZ=${TZ:-UTC}
    volumes:
      - ./data/ssh_keys:/root/.ssh:ro
      - ./data/question_sets:/workspace/question_sets:ro
      - bastion_workspace:/workspace
      - kubeconfig_volume:/kubeconfig
    working_dir: /workspace
    networks:
      - exam-network
    profiles:
      - template
    labels:
      - "com.k8s-exam.component=bastion-template"
      - "com.k8s-exam.type=exam-environment"

# ====================================
# è³‡æ–™å·å®šç¾©
# ====================================
volumes:
  # æŒä¹…åŒ–è³‡æ–™
  redis_data:
    driver: local
    labels:
      - "com.k8s-exam.data=persistent"

  # å»ºç½®ç”¢å‡º
  frontend_build:
    driver: local
    labels:
      - "com.k8s-exam.data=build"

  # å¿«å–è³‡æ–™
  kubespray_cache:
    driver: local
    labels:
      - "com.k8s-exam.data=cache"

  # è€ƒè©¦ç’°å¢ƒå·¥ä½œå€
  vnc_workspace:
    driver: local
    labels:
      - "com.k8s-exam.data=workspace"

  bastion_workspace:
    driver: local
    labels:
      - "com.k8s-exam.data=workspace"

  kubeconfig_volume:
    driver: local
    labels:
      - "com.k8s-exam.data=config"

# ====================================
# ç¶²è·¯å®šç¾©
# ====================================
networks:
  exam-network:
    name: k8s-exam-network
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.25.0.0/16
          gateway: 172.25.0.1
    labels:
      - "com.k8s-exam.network=main"