
# 實作計畫：Kubernetes 考試模擬器

**分支**: `001-k8s-home-ubuntu` | **日期**: 2025-09-22 | **規格**: [spec.md](./spec.md)
**輸入**: 功能規格來源 `/home/ubuntu/DW-CK/specs/001-k8s-home-ubuntu/spec.md`

## 執行流程 (/plan 指令範圍)
```
1. 從輸入路徑載入功能規格
   → 如果找不到：錯誤 "在 {path} 沒有功能規格"
2. 填寫技術內容（掃描需要澄清的項目）
   → 從內容偵測專案類型 (web=前端+後端, mobile=應用程式+API)
   → 根據專案類型設定結構決策
3. 根據憲章文件內容填寫憲章檢查章節
4. 評估下方憲章檢查章節
   → 如果有違規：記錄在複雜度追蹤中
   → 如果無法合理化：錯誤 "請先簡化方法"
   → 更新進度追蹤：初始憲章檢查
5. 執行階段 0 → research.md
   → 如果仍有需要澄清的項目：錯誤 "解決未知問題"
6. 執行階段 1 → 契約、data-model.md、quickstart.md、代理特定範本檔案 (例如 Claude Code 的 `CLAUDE.md`、GitHub Copilot 的 `.github/copilot-instructions.md`、Gemini CLI 的 `GEMINI.md`、Qwen Code 的 `QWEN.md` 或 opencode 的 `AGENTS.md`)
7. 重新評估憲章檢查章節
   → 如果有新違規：重構設計，回到階段 1
   → 更新進度追蹤：設計後憲章檢查
8. 規劃階段 2 → 描述任務產生方法（不建立 tasks.md）
9. 停止 - 準備執行 /tasks 指令
```

**重要**：/plan 指令在步驟 7 停止。階段 2-4 由其他指令執行：
- 階段 2：/tasks 指令建立 tasks.md
- 階段 3-4：實作執行（手動或透過工具）

## 摘要

全面的 Kubernetes 認證考試模擬器，提供真實考試環境、自動化環境配置、即時評分系統。支援 CKAD、CKA、CKS 多種認證類型，使用者可自行管理題庫，透過 Web 介面存取遠端桌面環境進行實作練習。

**核心架構**：容器化前後端分離設計，使用 Kubespray 自動化部署 Kubernetes 環境到使用者提供的 VM 叢集。

## 技術內容
**語言/版本**: Python 3.11+ (後端), React 18+ (前端)
**主要相依套件**: FastAPI, React, Docker, Kubespray, noVNC, Redis, SQLite
**儲存**: SQLite (本地資料), Redis (快取/會話), 檔案系統 (配置)
**測試**: pytest (後端), Jest/RTL (前端), 整合測試
**目標平台**: Linux 伺服器，透過 Docker Compose 容器化部署
**專案類型**: web - 決定前端/後端結構
**效能目標**: 單一並發使用者考試會話，VM 環境配置 <5min，即時 VNC 連線
**限制**: 單一活動會話限制，環境隔離，SSH 連線依賴性
**規模/範圍**: 單使用者系統，3種認證類型，可擴展題庫，自動化評分

## 憲章檢查
*關卡：必須在階段 0 研究前通過。階段 1 設計後重新檢查。*

**註記**：憲章範本為空，套用標準開發原則：

### ✅ 簡化原則
- 單一使用者系統設計，避免複雜的多租戶架構
- 清晰的前後端分離，每個服務單一職責

### ✅ 函式庫優先方法
- Kubespray 作為獨立的基礎設施管理組件
- 驗證腳本作為可重用的評分模組
- VNC/遠端桌面作為獨立的存取層

### ✅ 測試優先策略
- 每個 API 端點都有對應的契約測試
- 驗證腳本本身需要測試確保正確性
- 整合測試覆蓋完整的使用者流程

### ⚠️ 需要合理化的複雜區域
- Docker Compose 多容器編排（必要：隔離各服務）
- SSH 連線管理（必要：連接使用者 VM）
- VNC 代理設定（必要：Web 介面存取遠端桌面）

**狀態**：通過，並記錄複雜性

### 📋 設計後憲章檢查
完成階段 1 設計後（資料模型、契約、快速開始）：

✅ **簡化性維持**：
- 清晰的實體關係，避免過度正規化
- RESTful API 設計，遵循標準慣例
- 單一活動會話簡化並發處理

✅ **函式庫優先達成**：
- 明確的 API 契約和資料模型定義
- 可獨立測試的驗證腳本系統
- 模組化的 Kubernetes 配置管理

✅ **測試優先準備就緒**：
- 完整的 API 契約規格 (OpenAPI)
- 可測試的驗證腳本介面
- 清晰的整合測試場景

**最終狀態**：通過 - 設計符合憲章原則

## 系統整體架構與專案結構

### 高層系統架構圖
```
┌─────────────────────────────────────────────────────────────┐
│                    Kubernetes 考試模擬器                    │
├─────────────────────────────────────────────────────────────┤
│ 🌐 Web 層 (使用者存取)                                     │
│ ┌─────────────────┐   nginx 反向代理   ┌─────────────────┐ │
│ │ 使用者瀏覽器    │ ◄────────────────► │ port 80/443     │ │
│ │ (任意網段 IP)   │   動態 IP 適應      │ 統一入口點      │ │
│ └─────────────────┘                    └─────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 🔧 應用層 (容器化服務)                                     │
│ ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│ │ Frontend    │ Backend     │ VNC         │ Bastion     │   │
│ │ (React)     │ (FastAPI)   │ (noVNC)     │ (Alpine)    │   │
│ │ 靜態檔案    │ :8000       │ :6901       │ :22         │   │
│ └─────────────┴─────────────┴─────────────┴─────────────┘   │
│ ┌─────────────┬─────────────┬─────────────┐               │
│ │ Redis       │ SQLite      │ Kubespray   │               │
│ │ :6379       │ (檔案)      │ (Ansible)   │               │
│ │ 快取服務    │ 資料庫      │ 容器化部署  │               │
│ └─────────────┴─────────────┘                               │
├─────────────────────────────────────────────────────────────┤
│ 📁 資料層 (檔案系統 + 資料庫)                              │
│ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │
│ │ 題組檔案系統    │ │ SQLite 資料庫   │ │ VM 配置檔案     │ │
│ │ metadata.json   │ │ ExamSession     │ │ SSH 金鑰       │ │
│ │ questions.json  │ │ VMClusterConfig │ │ 會話配置生成    │ │
│ │ Kubespray 配置  │ │ ExamResult      │ │ kubespray_configs/│ │
│ │ 驗證腳本        │ │                 │ │ session_*/      │ │
│ └─────────────────┘ └─────────────────┘ └─────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 🖥️ 基礎設施層 (使用者提供)                                │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │         使用者 VM 叢集 (透過 SSH 連線)                 │ │
│ │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │ │
│ │ │ Master 節點 │ │ Worker 節點 │ │ Worker 節點 │  ...  │ │
│ │ │192.168.1.100│ │192.168.1.101│ │192.168.1.102│       │ │
│ │ └─────────────┘ └─────────────┘ └─────────────┘       │ │
│ │            ↑ Kubespray 自動部署 Kubernetes            │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### VNC + Bastion 雙容器架構圖
```
考試會話容器通信架構：

使用者瀏覽器
    ↓ HTTP (noVNC)
┌─────────────────────────────────────────────────────────────┐
│  nginx 反向代理                                             │
│  /vnc/{session_id}/* → vnc-{session_id}:6901              │
└─────────────────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────────────────┐
│  VNC Container (vnc-{session_id})                          │
│  ├── ConSol debian-xfce-vnc 基底                           │
│  ├── noVNC Web 介面 (port 6901)                           │
│  ├── 桌面環境 (Xfce4)                                      │
│  ├── SSH 客戶端 + 預設連線配置                              │
│  └── 基本工具 (vim, curl, 終端機)                          │
└─────────────────────────────────────────────────────────────┘
    ↓ SSH 連線
┌─────────────────────────────────────────────────────────────┐
│  Bastion Container (bastion-{session_id})                  │
│  ├── Alpine 3.19 基底 (~50MB 輕量映像)                    │
│  ├── SSH 服務 (port 22)                                   │
│  ├── kubectl + helm + jq + yq + 通用考試工具              │
│  ├── kubeconfig (掛載 volume)                             │
│  └── 題組腳本 (掛載 volume)                               │
└─────────────────────────────────────────────────────────────┘
    ↓ kubectl 命令
┌─────────────────────────────────────────────────────────────┐
│  使用者 Kubernetes 叢集                                    │
│  ├── Master 節點 (192.168.1.100)                          │
│  └── Worker 節點 (192.168.1.101+)                         │
└─────────────────────────────────────────────────────────────┘

會話生命週期：
1. 考試開始 → 啟動 VNC + Bastion 容器對
2. 使用者操作 → VNC 桌面 → SSH 到 Bastion → kubectl 操作
3. 驗證執行 → 在 Bastion 內執行驗證腳本
4. 考試結束 → 清理兩個容器
```

### 文件結構（此功能）
```
specs/[###-feature]/
├── plan.md              # 此檔案 (/plan 指令輸出)
├── research.md          # 階段 0 輸出 (/plan 指令)
├── data-model.md        # 階段 1 輸出 (/plan 指令)
├── quickstart.md        # 階段 1 輸出 (/plan 指令)
├── contracts/           # 階段 1 輸出 (/plan 指令)
└── tasks.md             # 階段 2 輸出 (/tasks 指令 - 不由 /plan 建立)
```

### 原始碼結構（儲存庫根目錄）
```
# 選項 2：Web 應用程式（偵測到 "frontend" + "backend"）

nginx/               # nginx 反向代理配置
├── nginx.conf       # 主配置檔案
├── ssl/            # SSL 憑證 (可選)
└── conf.d/         # 虛擬主機配置

backend/            # FastAPI 後端服務
├── src/
│   ├── models/     # SQLAlchemy 資料模型
│   ├── services/   # 業務邏輯服務
│   ├── api/        # API 路由和控制器
│   └── lib/        # 共用程式庫
└── tests/
    ├── contract/   # API 契約測試
    ├── integration/# 整合測試
    └── unit/       # 單元測試

frontend/           # React 前端應用
├── src/
│   ├── components/ # UI 組件
│   ├── pages/      # 頁面組件
│   ├── services/   # API 客戶端 (相對路徑)
│   └── utils/      # 工具函式
└── tests/
    ├── components/ # 組件測試
    └── integration/# E2E 測試

vnc/                # VNC 容器配置
├── Dockerfile      # 基於 ConSol debian-xfce-vnc 的輕量客製化
├── ssh_config      # SSH 客戶端預設配置
└── startup.sh      # 啟動腳本

bastion/            # Bastion 容器配置
├── Dockerfile      # Alpine 基底 + kubectl/helm 等工具
├── sshd_config     # SSH 服務配置
└── entrypoint.sh   # 容器啟動腳本

kubespray/          # Kubespray 服務配置
├── docker-compose.yml  # 使用官方映像 quay.io/kubespray/kubespray
└── scripts/           # 配置生成腳本
    ├── generate_inventory.py  # 動態生成 inventory
    └── deploy_cluster.py      # 部署腳本

data/               # 資料存儲目錄
├── ssh_keys/       # SSH 金鑰目錄 (使用者管理)
│   ├── id_rsa     # 固定的 SSH 私鑰
│   └── README.md  # 使用說明
├── vm_configs/     # VM 配置檔案 (簡化)
├── kubespray_configs/  # Kubespray 會話配置 (mount 到容器)
│   ├── session_001/   # API 動態創建
│   ├── session_002/   # 每個會話獨立配置
│   └── ...
└── question_sets/  # 題組檔案和 Kubespray 配置
    ├── cka/001/                   # CKA 題組 001
    │   ├── metadata.json          # 題組元資料
    │   ├── questions.json         # 題目內容
    │   ├── base-overwrite.yml     # 覆蓋基礎 K8s 配置
    │   ├── addons-overwrite.yml   # 覆蓋 addon 配置
    │   ├── network/               # CNI 網路配置目錄
    │   │   └── k8s-net-calico.yml # Calico CNI 配置
    │   └── scripts/               # 驗證腳本
    ├── cks/001/                   # CKS 題組 001
    │   ├── metadata.json
    │   ├── questions.json
    │   ├── base-overwrite.yml     # CKS 特定配置
    │   ├── addons-overwrite.yml
    │   ├── network/               # CNI 網路配置目錄
    │   │   ├── k8s-net-cilium.yml # Cilium CNI 配置
    │   │   └── security-policy.yml # 安全網路策略
    │   └── scripts/
    └── templates/                 # 全域 Kubespray 範本
        ├── all/
        │   └── etcd.yml           # 預設 etcd 配置
        ├── base.yml               # 預設 k8s-cluster.yml
        └── addons.yml             # 預設 addons.yml

docker-compose.yml  # 容器編排配置
.env.example        # 環境變數範本
```

**結構決策**：[預設為選項 1，除非技術內容指示 web/mobile 應用程式]

## 階段 0：大綱與研究
1. **從上述技術內容中提取未知項目**：
   - 每個需要澄清的項目 → 研究任務
   - 每個相依項目 → 最佳實務任務
   - 每個整合項目 → 模式任務

2. **產生並派遣研究代理**：
   ```
   對於技術內容中的每個未知項目：
     任務："為 {功能內容} 研究 {未知項目}"
   對於每個技術選擇：
     任務："在 {領域} 中尋找 {技術} 的最佳實務"
   ```

3. **在 `research.md` 中整合發現**，使用格式：
   - 決策：[選擇了什麼]
   - 理由：[為什麼選擇]
   - 考慮的替代方案：[還評估了什麼]

**輸出**：research.md，解決所有需要澄清的項目

## 階段 1：設計與契約
*先決條件：research.md 完成*

1. **從功能規格中提取實體** → `data-model.md`：
   - 實體名稱、欄位、關係
   - 來自需求的驗證規則
   - 狀態轉換（如適用）

2. **從功能需求產生 API 契約**：
   - 每個使用者行為 → 端點
   - 使用標準 REST/GraphQL 模式
   - 輸出 OpenAPI/GraphQL 結構描述到 `/contracts/`

3. **從契約產生契約測試**：
   - 每個端點一個測試檔案
   - 斷言請求/回應結構描述
   - 測試必須失敗（尚無實作）

4. **從使用者故事中提取測試場景**：
   - 每個故事 → 整合測試場景
   - 快速開始測試 = 故事驗證步驟

5. **漸進式更新代理檔案**（O(1) 操作）：
   - 執行 `.specify/scripts/bash/update-agent-context.sh claude`
     **重要**：完全按照上述指定執行。不要新增或移除任何參數。
   - 如果存在：只新增來自當前計畫的新技術
   - 保留標記之間的手動新增
   - 更新最近變更（保留最後 3 個）
   - 保持在 150 行以下以提高 token 效率
   - 輸出到儲存庫根目錄

**輸出**：data-model.md、/contracts/*、失敗測試、quickstart.md、代理特定檔案

## 階段 2：任務規劃方法
*此章節描述 /tasks 指令將執行的內容 - 在 /plan 期間不執行*

**任務產生策略**：
基於階段 1 產出的設計文件生成具體實作任務：

1. **契約測試**（從 api-spec.yaml）：
   - VM 配置 API 契約測試 [P]
   - 題組讀取 API 契約測試 [P]
   - 題組重載 API 契約測試 [P]
   - 考試會話 API 契約測試 [P]
   - 環境管理 API 契約測試 [P]
   - VNC 存取 API 契約測試 [P]

2. **資料模型**（從 data-model.md）：
   - ExamSession, VMClusterConfig 資料庫模型 [P]
   - ExamResult, QuestionResult 資料庫模型 [P]
   - QuestionSetFileManager 服務類別 [P]
   - QuestionSetData, QuestionData 記憶體物件 [P]
   - 資料庫遷移腳本

3. **核心服務**：
   - VM 連線測試服務
   - Kubespray 整合服務
   - 驗證腳本執行引擎
   - 會話狀態管理服務
   - JSON 檔案解析和驗證服務
   - 檔案監控和自動重載服務

4. **整合組件**：
   - VNC 代理設定
   - Docker Compose 配置
   - Redis 會話存儲
   - 題組檔案系統結構

5. **前端組件**：
   - VM 配置管理介面
   - 題組瀏覽介面（唯讀）
   - 考試會話控制面板
   - VNC 遠端桌面整合
   - 題目導航和評分顯示

**排序策略**：
1. **階段 2a** - 基礎設施（契約測試 → 資料模型 → 檔案系統服務）
2. **階段 2b** - 核心功能（題組載入 → VM 管理 → 環境配置 → 考試引擎）
3. **階段 2c** - 整合（VNC 整合 → 前端介面 → E2E 測試）

**相依關係**：
- QuestionSetFileManager → 題組 API 服務
- 檔案監控服務 → 自動重載功能
- VM 連線服務 → Kubespray 整合
- 會話管理 → VNC 存取令牌
- 前端組件 → API 客戶端

**並發執行標記 [P]**：
- 獨立 API 端點測試
- 不同實體的模型定義
- 獨立的前端組件

**預估輸出**：28-32 個有序任務，分為 3 個主要階段

**特殊考量**：
- JSON 檔案格式驗證和錯誤處理任務
- 檔案監控和熱重載任務
- SSH 金鑰安全處理任務
- Kubespray 容器化整合任務
- VNC 效能優化任務
- 記憶體快取管理任務

**重要**：此階段由 /tasks 指令執行，/plan 指令不執行

## 階段 3+：未來實作
*這些階段超出了 /plan 指令的範圍*

**階段 3**：任務執行（/tasks 指令建立 tasks.md）  
**階段 4**：實作（執行 tasks.md，遵循憲章原則）  
**階段 5**：驗證（執行測試、執行 quickstart.md、效能驗證）

## 複雜度追蹤
*只在憲章檢查有必須合理化的違規時填寫*

| 違規 | 為什麼需要 | 拒絕更簡單替代方案的原因 |
|------|------------|--------------------------|
| [例如，第4個專案] | [當前需求] | [為什麼3個專案不足] |
| [例如，Repository 模式] | [具體問題] | [為什麼直接DB存取不足] |


## 進度追蹤
*此檢查清單在執行流程期間更新*

**階段狀態**：
- [x] 階段 0：研究完成（/plan 指令）✅ 2025-09-22
- [x] 階段 1：設計完成（/plan 指令）✅ 2025-09-22
- [x] 階段 2：任務規劃完成（/plan 指令 - 僅描述方法）✅ 2025-09-22
- [ ] 階段 3：任務產生（/tasks 指令）
- [ ] 階段 4：實作完成
- [ ] 階段 5：驗證通過

**關卡狀態**：
- [x] 初始憲章檢查：通過 ✅
- [x] 設計後憲章檢查：通過 ✅
- [x] 所有需要澄清的項目已解決 ✅
- [x] 複雜度偏差已記錄 ✅

**產生的產出**：
- [x] research.md - 技術決策和架構研究
- [x] data-model.md - 完整資料模型設計
- [x] contracts/api-spec.yaml - OpenAPI 3.0 規格
- [x] quickstart.md - 系統安裝和使用指南
- [x] CLAUDE.md - 更新 AI 助手上下文

**準備執行**：`/tasks` 指令執行以生成具體實作任務

---
*基於憲章 v2.1.1 - 參見 `/memory/constitution.md`*
