# Kubernetes è€ƒè©¦ç’°å¢ƒå°ˆç”¨ .bashrc (Bastion Container)

# å¦‚æœä¸æ˜¯äº’å‹•å¼ shellï¼Œç›´æ¥è¿”å›
[[ $- != *i* ]] && return

# æ­·å²è¨˜éŒ„è¨­å®š
HISTCONTROL=ignoreboth:erasedups
HISTSIZE=50000
HISTFILESIZE=100000
shopt -s histappend
shopt -s checkwinsize
shopt -s cmdhist

# åœ¨æ¯å€‹å‘½ä»¤å¾Œå„²å­˜æ­·å²è¨˜éŒ„
PROMPT_COMMAND='history -a'

# å½©è‰²æç¤ºç¬¦ (åŒ…å«ç•¶å‰ namespace)
get_kube_namespace() {
    if [ -n "$KUBECONFIG" ] && command -v kubectl >/dev/null 2>&1; then
        kubectl config view --minify --output 'jsonpath={..namespace}' 2>/dev/null || echo "default"
    else
        echo "default"
    fi
}

if [ -x /usr/bin/tput ] && tput setaf 1 >&/dev/null; then
    PS1='\[\033[01;32m\]\u@bastion\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\] \[\033[01;33m\][$(get_kube_namespace)]\[\033[00m\]\$ '
else
    PS1='\u@bastion:\w [$(get_kube_namespace)]\$ '
fi

# å•Ÿç”¨å½©è‰²è¼¸å‡º
if [ -x /usr/bin/dircolors ]; then
    alias ls='ls --color=auto'
    alias grep='grep --color=auto'
    alias fgrep='fgrep --color=auto'
    alias egrep='egrep --color=auto'
fi

# åŸºæœ¬åˆ¥å
alias ll='ls -alF'
alias la='ls -A'
alias l='ls -CF'

# Kubernetes å°ˆç”¨åˆ¥å - åŸºæœ¬æ“ä½œ
alias k='kubectl'
alias kgp='kubectl get pods'
alias kgpo='kubectl get pods -o wide'
alias kgs='kubectl get services'
alias kgd='kubectl get deployments'
alias kgn='kubectl get nodes'
alias kgns='kubectl get namespaces'
alias kgpv='kubectl get pv'
alias kgpvc='kubectl get pvc'
alias kgsec='kubectl get secrets'
alias kgcm='kubectl get configmaps'
alias kging='kubectl get ingress'

# Kubernetes å°ˆç”¨åˆ¥å - æ“ä½œ
alias kaf='kubectl apply -f'
alias kdf='kubectl delete -f'
alias kcf='kubectl create -f'
alias krp='kubectl replace -f'

# Kubernetes å°ˆç”¨åˆ¥å - æè¿°
alias kdp='kubectl describe pod'
alias kds='kubectl describe service'
alias kdd='kubectl describe deployment'
alias kdn='kubectl describe node'
alias kdns='kubectl describe namespace'
alias kdsec='kubectl describe secret'
alias kdcm='kubectl describe configmap'

# Kubernetes å°ˆç”¨åˆ¥å - æ—¥èªŒ
alias kl='kubectl logs'
alias klf='kubectl logs -f'
alias klp='kubectl logs --previous'

# Kubernetes å°ˆç”¨åˆ¥å - åŸ·è¡Œå’Œé™¤éŒ¯
alias ke='kubectl exec'
alias kei='kubectl exec -it'
alias kpf='kubectl port-forward'

# é€²éš Kubernetes åˆ¥å
alias kwatch='kubectl get pods -w'
alias kall='kubectl get all'
alias kallns='kubectl get all --all-namespaces'
alias ktop='kubectl top'
alias ktn='kubectl top nodes'
alias ktp='kubectl top pods'

# Namespace ç®¡ç†å‡½æ•¸
kns() {
    if [ -z "$1" ]; then
        kubectl config view --minify --output 'jsonpath={..namespace}'
        echo
    else
        kubectl config set-context --current --namespace=$1
        echo "å·²åˆ‡æ›åˆ° namespace: $1"
    fi
}

# å¿«é€Ÿè³‡æºå»ºç«‹å‡½æ•¸
mkpod() {
    local name=${1:-test-pod}
    local image=${2:-nginx}
    local namespace=${3:-$(get_kube_namespace)}
    kubectl run $name --image=$image --restart=Never --namespace=$namespace --dry-run=client -o yaml
}

mkdeploy() {
    local name=${1:-test-deploy}
    local image=${2:-nginx}
    local replicas=${3:-1}
    local namespace=${4:-$(get_kube_namespace)}
    kubectl create deployment $name --image=$image --replicas=$replicas --namespace=$namespace --dry-run=client -o yaml
}

mksvc() {
    local name=${1:-test-svc}
    local port=${2:-80}
    local target_port=${3:-80}
    local namespace=${4:-$(get_kube_namespace)}
    kubectl create service clusterip $name --tcp=$port:$target_port --namespace=$namespace --dry-run=client -o yaml
}

mkcm() {
    local name=${1:-test-cm}
    local namespace=${2:-$(get_kube_namespace)}
    shift 2
    kubectl create configmap $name --namespace=$namespace --dry-run=client -o yaml "$@"
}

mksecret() {
    local name=${1:-test-secret}
    local namespace=${2:-$(get_kube_namespace)}
    shift 2
    kubectl create secret generic $name --namespace=$namespace --dry-run=client -o yaml "$@"
}

# å¿«é€Ÿæª¢æŸ¥å‡½æ•¸
check() {
    echo "=== å¢é›†æ¦‚æ³ ==="
    kubectl get nodes -o wide
    echo
    echo "=== ç•¶å‰ Namespace ($( get_kube_namespace )) ==="
    kubectl get all
    echo
    echo "=== ç³»çµ± Pods ==="
    kubectl get pods -n kube-system --no-headers | wc -l | xargs echo "ç³»çµ± Pods æ•¸é‡:"
    echo
    echo "=== å¢é›†è³‡æºä½¿ç”¨ ==="
    kubectl top nodes 2>/dev/null || echo "metrics-server æœªå®‰è£"
}

checkall() {
    echo "=== æ‰€æœ‰ Namespaces è³‡æº ==="
    kubectl get all --all-namespaces
}

# æ¸…ç†å‡½æ•¸
cleanup() {
    local namespace=$(get_kube_namespace)
    echo "ç•¶å‰ namespace: $namespace"
    read -p "ç¢ºå®šè¦æ¸…ç† '$namespace' namespace çš„æ‰€æœ‰è³‡æºï¼Ÿ (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "æ¸…ç†ä¸­..."
        kubectl delete --all pods,services,deployments,configmaps,secrets,ingress,pvc --namespace=$namespace
        echo "æ¸…ç†å®Œæˆ"
    else
        echo "å·²å–æ¶ˆ"
    fi
}

# è€ƒè©¦è¨ˆæ™‚å™¨
timer() {
    local seconds=${1:-7200}  # é è¨­ 2 å°æ™‚ (CKA/CKAD è€ƒè©¦æ™‚é–“)
    local start_time=$(date +%s)
    local end_time=$((start_time + seconds))

    echo "è€ƒè©¦è¨ˆæ™‚å™¨å•Ÿå‹•ï¼š$seconds ç§’ (çµæŸæ™‚é–“: $(date -d @$end_time '+%H:%M:%S'))"

    while [ $(date +%s) -lt $end_time ]; do
        local remaining=$((end_time - $(date +%s)))
        local hours=$((remaining / 3600))
        local minutes=$(((remaining % 3600) / 60))
        local secs=$((remaining % 60))

        printf "\rå‰©é¤˜æ™‚é–“: %02d:%02d:%02d" $hours $minutes $secs
        sleep 1
    done

    echo -e "\nâ° è€ƒè©¦æ™‚é–“çµæŸï¼"
    # ç™¼å‡ºéŸ¿éˆ´ (å¦‚æœæ”¯æ´)
    echo -e "\a"
}

# YAML é©—è­‰å‡½æ•¸
yamlcheck() {
    if [ -z "$1" ]; then
        echo "ä½¿ç”¨æ–¹å¼: yamlcheck <æª”æ¡ˆå>"
        return 1
    fi

    if [ ! -f "$1" ]; then
        echo "æª”æ¡ˆä¸å­˜åœ¨: $1"
        return 1
    fi

    echo "æª¢æŸ¥ YAML èªæ³•..."
    if kubectl apply --dry-run=client -f "$1" >/dev/null 2>&1; then
        echo "âœ“ YAML èªæ³•æ­£ç¢º"
        kubectl apply --dry-run=client -f "$1"
    else
        echo "âœ— YAML èªæ³•éŒ¯èª¤"
        kubectl apply --dry-run=client -f "$1"
        return 1
    fi
}

# ç’°å¢ƒè®Šæ•¸
export EDITOR=vim
export VISUAL=vim
export KUBE_EDITOR=vim
export TERM=xterm-256color
export KUBECONFIG=${KUBECONFIG:-/kubeconfig/config}

# kubectl è‡ªå‹•å®Œæˆ
if command -v kubectl > /dev/null 2>&1; then
    source <(kubectl completion bash)
    complete -F __start_kubectl k
fi

# helm è‡ªå‹•å®Œæˆ
if command -v helm > /dev/null 2>&1; then
    source <(helm completion bash)
fi

# è¼‰å…¥é¡å¤–çš„åˆ¥å
if [ -f ~/.bash_aliases ]; then
    source ~/.bash_aliases
fi

# æ­¡è¿è¨Šæ¯
if [ "$PS1" ]; then
    echo ""
    echo "ğŸ¯ Kubernetes è€ƒè©¦ç’°å¢ƒå·²æº–å‚™å°±ç·’ï¼"
    echo ""
    echo "ğŸ“ å¸¸ç”¨æŒ‡ä»¤ï¼š"
    echo "   k               - kubectl ç°¡å¯«"
    echo "   kns <namespace> - åˆ‡æ› namespace"
    echo "   check           - æª¢æŸ¥å¢é›†ç‹€æ…‹"
    echo "   timer <ç§’æ•¸>    - å•Ÿå‹•è€ƒè©¦è¨ˆæ™‚å™¨"
    echo "   cleanup         - æ¸…ç†ç•¶å‰ namespace"
    echo "   yamlcheck <æª”æ¡ˆ> - é©—è­‰ YAML æª”æ¡ˆ"
    echo ""
    echo "ğŸ›  å¿«é€Ÿå»ºç«‹ï¼š"
    echo "   mkpod <åç¨±> <æ˜ åƒ>     - å»ºç«‹ Pod YAML"
    echo "   mkdeploy <åç¨±> <æ˜ åƒ>  - å»ºç«‹ Deployment YAML"
    echo "   mksvc <åç¨±> <ç«¯å£>     - å»ºç«‹ Service YAML"
    echo ""
    echo "ğŸ“‚ å·¥ä½œç›®éŒ„: /workspace"
    echo "ğŸ“ ç›®å‰ namespace: $(get_kube_namespace)"
    echo ""
fi